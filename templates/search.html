{% extends "base.html" %}

{% block content %}
<h1 class="title">
  {{ page.title }}
</h1>
{{ page.content | safe }}

<div class="search-page-container">
  <div class="local-search-section">
    <h2>Local Search</h2>
    <p>Search through all site content instantly. Results are sorted by relevance and include excerpts from matching content.</p>
    
    <div class="search-container search-page-search">
      <input type="search" 
             id="search-input-page" 
             class="search-input" 
             placeholder="Search publications, projects, talks, teaching..." 
             autocomplete="off"
             aria-label="Search site content">
      <div id="search-results-page" class="search-results search-results-page"></div>
    </div>
    
    <div id="search-stats" class="search-stats" style="display: none;">
      <p><span id="result-count">0</span> results found</p>
    </div>
    
    <div class="search-tips">
      <h3>Search Tips</h3>
      <ul>
        <li>Type at least 2 characters to see results</li>
        <li>Use multiple words to narrow down results</li>
        <li>Use arrow keys to navigate through results</li>
        <li>Press Enter to open the highlighted result</li>
        <li>Press Escape to close search results</li>
      </ul>
    </div>
  </div>

  <div class="external-search-section">
    <h2>External Search</h2>
    <p>You can also search the site using DuckDuckGo for additional results:</p>

    <form method="get" action="https://duckduckgo.com/?q=" target="_blank">
      <input type="hidden" name="sites" value="melashri.net">
      <label class="small" for="searchDDG">External search with DuckDuckGo:</label>
      <input aria-label="Search" type="search" name="q" id="searchDDG" placeholder="e.g. CUDA, particle physics">
      <input type="submit" name="submit" value="Search with DuckDuckGo" id="submit">
      <input type="hidden" name="kae" value="t"/>
      <input type="hidden" name="ka" value="g"/>
      <input type="hidden" name="kt" value="g"/>
      <input type="hidden" name="k1" value="-1"/>
      <input type="hidden" name="kz" value="-1"/>
      <input type="hidden" name="km" value="l"/>
    </form>
  </div>
</div>

<style>
.search-page-container {
  max-width: 800px;
}

.local-search-section, .external-search-section {
  margin-bottom: 3rem;
}

.search-page-search {
  position: relative;
  margin: 1.5rem 0;
}

.search-results-page {
  position: static;
  display: block;
  max-height: none;
  border: 1px solid var(--border);
  border-radius: var(--standard-border-radius);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  margin-top: 0.5rem;
}

.search-stats {
  margin-top: 1rem;
  color: var(--text-light);
  font-size: 0.9rem;
}

.search-tips {
  background-color: var(--accent-bg);
  padding: 1.5rem;
  border-radius: var(--standard-border-radius);
  margin-top: 2rem;
}

.search-tips h3 {
  margin-top: 0;
  margin-bottom: 1rem;
  color: var(--text-dark);
}

.search-tips ul {
  margin: 0;
  padding-left: 1.5rem;
}

.search-tips li {
  margin-bottom: 0.5rem;
  color: var(--text-light);
}

.external-search-section form {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
  max-width: 400px;
}

.external-search-section label {
  font-weight: 600;
  color: var(--text-dark);
}

.external-search-section input[type="search"] {
  padding: 0.5rem;
  border: 1px solid var(--border);
  border-radius: var(--standard-border-radius);
  font-size: 1rem;
}

.external-search-section input[type="submit"] {
  padding: 0.75rem 1rem;
  background-color: var(--accent);
  color: var(--text-hover);
  border: none;
  border-radius: var(--standard-border-radius);
  cursor: pointer;
  transition: background-color var(--transition);
  font-size: 1rem;
  font-weight: 600;
}

.external-search-section input[type="submit"]:hover {
  background-color: var(--accent-hover);
}

@media only screen and (max-width: 810px) {
  .search-page-container {
    padding: 0 1rem;
  }
  
  .search-tips {
    padding: 1rem;
  }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // Setup search for the search page
  const pageSearchInput = document.getElementById('search-input-page');
  const pageSearchResults = document.getElementById('search-results-page');
  const searchStats = document.getElementById('search-stats');
  const resultCount = document.getElementById('result-count');
  
  if (pageSearchInput && window.localSearch) {
    // Wait for search to be ready
    const checkSearchReady = () => {
      if (window.localSearch && window.localSearch.isSearchReady) {
        setupPageSearch();
      } else {
        setTimeout(checkSearchReady, 100);
      }
    };
    
    const setupPageSearch = () => {
      pageSearchInput.addEventListener('input', window.localSearch.debounce((event) => {
        const query = event.target.value.trim().toLowerCase();
        
        if (query.length < 2) {
          pageSearchResults.style.display = 'none';
          searchStats.style.display = 'none';
          return;
        }

        // Temporarily override search components for page search
        const originalInput = window.localSearch.searchInput;
        const originalResults = window.localSearch.searchResults;
        
        window.localSearch.searchInput = pageSearchInput;
        window.localSearch.searchResults = pageSearchResults;
        
        window.localSearch.performSearch(query);
        
        // Restore original components
        window.localSearch.searchInput = originalInput;
        window.localSearch.searchResults = originalResults;
        
        // Update stats
        resultCount.textContent = window.localSearch.currentResults.length;
        searchStats.style.display = 'block';
        pageSearchResults.style.display = 'block';
      }, 300));
      
      pageSearchInput.addEventListener('keydown', (event) => {
        const originalInput = window.localSearch.searchInput;
        const originalResults = window.localSearch.searchResults;
        
        window.localSearch.searchInput = pageSearchInput;
        window.localSearch.searchResults = pageSearchResults;
        
        window.localSearch.handleKeydown(event);
        
        window.localSearch.searchInput = originalInput;
        window.localSearch.searchResults = originalResults;
      });
    };
    
    checkSearchReady();
  }
});
</script>

{% endblock content %}